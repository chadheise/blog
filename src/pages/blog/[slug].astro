---
import Layout from "../../layouts/Layout.astro";
import BlogPostLayout from "../../components/PostLayout.astro";
import { parseAndSortBlogPosts, transformImagePaths } from "../../lib/post";

interface Props {
  slug: string;
}

export async function getStaticPaths() {
  const posts = await parseAndSortBlogPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { slug } = Astro.params as Props;
const posts = await import.meta.glob<Record<string, any>>(
  "/src/content/blog/*.md",
  { eager: true },
);

// Find the markdown file that matches this slug
let selectedPost = null;
let Content = null;

for (const [filePath, module] of Object.entries(posts)) {
  const fileName = filePath.split("/").pop() || "";
  const fileSlug = fileName.replace(/\.md$/, "");

  if (fileSlug === slug) {
    selectedPost = module;
    Content = module.default;
    break;
  }
}

if (!selectedPost || !Content) {
  return Astro.redirect("/blog");
}

const { frontmatter } = selectedPost;
---

<Layout title={frontmatter.title}>
  <BlogPostLayout
    title={frontmatter.title}
    date={frontmatter.date}
    tags={frontmatter.tags}
    backLink={{ href: "/blog", label: "Blog" }}
  >
    <Content />
  </BlogPostLayout>
</Layout>
